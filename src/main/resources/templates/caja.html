<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">
<head>
<title>M贸dulo de Caja</title>
<link href="/css/bootstrap.min.css" rel="stylesheet"/>
<link href="/css/styles.css" rel="stylesheet"/>
</head>
<body>
<div class="container mt-5">
    <h1>M贸dulo de Caja</h1>
    <!--  Mensaje flotante -->
    <div class="alert" id="mensajeFlotante" style="position: fixed; top: 20px; right: 20px; display: none;">
    <span id="mensajeTexto"></span>
    </div>


    <form id="formCaja" onsubmit="event.preventDefault(); registrarMovimiento();">
        <input type="hidden" id="_csrf" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <!-- Tipo -->
        <div class="mb-3">
            <label class="form-label" for="tipo">Tipo</label>
            <select class="form-select" id="tipo" name="tipo" onchange="toggleCampos()">
                <option value="INGRESO">Ingreso</option>
                <option value="EGRESO">Egreso</option>
            </select>
        </div>

        <!-- Descripci贸n -->
        <div class="mb-3">
            <label class="form-label" for="descripcion">Descripci贸n</label>
            <input class="form-control" id="descripcion" name="descripcion" type="text" required />
        </div>

        <!-- Producto (solo ingresos) -->
        <div class="mb-3" id="productoSection">
            <label class="form-label" for="idArticulo">Producto</label>
            <select class="form-select" id="idArticulo" name="idArticulo" onchange="mostrarMonto()">
                <option value="">Seleccione un producto</option>
                <option th:each="producto : ${productos}" 
                        th:value="${producto.idArticulo}" 
                        th:data-precio="${producto.precioUnitario}"
                        th:text="${producto.nombre}"></option>        </select>
        </div>

        <!-- Cantidad -->
        <div class="mb-3" id="cantidadSection">
            <label class="form-label" for="cantidad">Cantidad</label>
            <input class="form-control" id="cantidad" name="cantidad" type="number" min="1" oninput="mostrarMonto()" />
        </div>

        <!-- Monto estimado -->
        <div class="mb-3">
            <label class="form-label">Monto estimado</label>
            <input class="form-control" id="montoVisual" type="text"/>
        </div>

        <button class="btn btn-primary" type="submit">Registrar</button>
        <a class="btn btn-secondary" href="/dashboard">Volver al Men煤</a>
    </form>

    <script>
        function toggleCampos() {
            const tipo = document.getElementById("tipo").value;
            document.getElementById("productoSection").style.display = tipo === "INGRESO" ? "block" : "none";
            document.getElementById("cantidadSection").style.display = tipo === "INGRESO" ? "block" : "none";
        }

        function mostrarMonto() {
            const producto = document.getElementById("idArticulo");
            const cantidad = parseInt(document.getElementById("cantidad").value) || 0;
            const precio = parseFloat(producto.options[producto.selectedIndex].getAttribute("data-precio")) || 0;
            document.getElementById("montoVisual").value = (precio * cantidad).toLocaleString("es-PY", {style: "currency", currency: "PYG"});
        }

        async function registrarMovimiento() {
            const descripcion = document.getElementById("descripcion").value;
            const tipo = document.getElementById("tipo").value;
            const csrfToken = document.getElementById("_csrf").value;

            const dto = { descripcion, tipo };

            if (tipo === "EGRESO") {
                const monto = parseFloat(document.getElementById("montoVisual").value);
                if (isNaN(monto) || monto <= 0) {
                    alert("Debe ingresar un monto v谩lido.");
                    return;
                }
                dto.monto = monto;
            } else {
                const idArticulo = parseInt(document.getElementById("idArticulo").value);
                const cantidad = parseInt(document.getElementById("cantidad").value);
                const precio = parseFloat(document.getElementById("idArticulo").selectedOptions[0].getAttribute("data-precio"));

                if (isNaN(idArticulo) || isNaN(cantidad) || cantidad <= 0 || isNaN(precio)) {
                    alert("Debe seleccionar un producto y una cantidad v谩lida.");
                    return;
                }

                dto.idArticulo = idArticulo;
                dto.cantidad = cantidad;
                dto.monto = cantidad * precio;
            }

            try {
                const response = await fetch("/api/caja/registrar", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRF-TOKEN": csrfToken
                    },
                    body: JSON.stringify(dto)
                });

                const resultado = await response.text();
                alert(resultado);
                document.getElementById("formCaja").reset();
                document.getElementById("montoVisual").value = "";
                toggleCampos();
            } catch (error) {
                alert("Error al registrar movimiento: " + error.message);
            }
        }

        window.onload = toggleCampos;
    </script>
</body>
</html>