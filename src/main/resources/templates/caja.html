<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<title>M√≥dulo de Caja</title>
<link href="/css/bootstrap.min.css" rel="stylesheet"/>
<link href="/css/styles.css" rel="stylesheet"/>
</head>
<body>
<div class="container mt-5">
    <h1>M√≥dulo de Caja</h1>

    <!-- üìå Contenedor para mensajes -->
    <div id="mensajeContainer"></div>

    <form id="formCaja" onsubmit="event.preventDefault(); registrarMovimiento();">
        <input type="hidden" id="_csrf" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <!-- Tipo -->
        <div class="mb-3">
            <label class="form-label" for="tipo">Tipo</label>
            <select class="form-select" id="tipo" name="tipo" onchange="toggleCampos()">
                <option value="INGRESO">Ingreso</option>
                <option value="EGRESO">Egreso</option>
            </select>
        </div>

        <!-- Descripci√≥n -->
        <div class="mb-3">
            <label class="form-label" for="descripcion">Descripci√≥n</label>
            <input class="form-control" id="descripcion" name="descripcion" type="text" required />
        </div>

        <!-- Producto (solo ingresos) -->
        <div class="mb-3" id="productoSection">
            <label class="form-label" for="idArticulo">Producto</label>
            <select class="form-select" id="idArticulo" name="idArticulo" onchange="mostrarMonto()">
                <option value="">Seleccione un producto</option>
                <option th:each="producto : ${productos}" 
                        th:value="${producto.idArticulo}" 
                        th:data-precio="${producto.precioUnitario}"
                        th:text="${producto.nombre}"></option>
            </select>
        </div>

        <!-- Cantidad -->
        <div class="mb-3" id="cantidadSection">
            <label class="form-label" for="cantidad">Cantidad</label>
            <input class="form-control" id="cantidad" name="cantidad" type="number" min="1" oninput="mostrarMonto()" />
        </div>

        <!-- Monto estimado -->
        <div class="mb-3">
            <label class="form-label">Monto estimado</label>
            <input class="form-control" id="montoVisual" type="text"/>
        </div>

        <button class="btn btn-primary" type="submit">Registrar</button>
        <a class="btn btn-secondary" href="/dashboard">Volver al Men√∫</a>
    </form>
</div>

<script>
    function toggleCampos() {
        const tipo = document.getElementById("tipo").value;
        document.getElementById("productoSection").style.display = tipo === "INGRESO" ? "block" : "none";
        document.getElementById("cantidadSection").style.display = tipo === "INGRESO" ? "block" : "none";
    }

    function mostrarMonto() {
        const producto = document.getElementById("idArticulo");
        const cantidad = parseInt(document.getElementById("cantidad").value) || 0;
        const precio = parseFloat(producto.options[producto.selectedIndex]?.getAttribute("data-precio")) || 0;
        document.getElementById("montoVisual").value = (precio * cantidad).toLocaleString("es-PY", {style: "currency", currency: "PYG"});
    }

    function mostrarMensaje(mensaje, tipo = "success") {
        const container = document.getElementById("mensajeContainer");
        container.innerHTML = `
            <div class="alert alert-${tipo} alert-dismissible fade show mt-3" role="alert">
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            </div>
        `;
    }

    async function registrarMovimiento() {
        const descripcion = document.getElementById("descripcion").value;
        const tipo = document.getElementById("tipo").value;
        const csrfToken = document.getElementById("_csrf").value;

        const dto = { descripcion, tipo };

        if (tipo === "EGRESO") {
            const monto = parseFloat(document.getElementById("montoVisual").value.replace(/[^\d]/g, ""));
            if (isNaN(monto) || monto <= 0) {
                mostrarMensaje("‚ö†Ô∏è Debe ingresar un monto v√°lido.", "danger");
                return;
            }
            dto.monto = monto;
        } else {
            const idArticulo = parseInt(document.getElementById("idArticulo").value);
            const cantidad = parseInt(document.getElementById("cantidad").value);
            const precio = parseFloat(document.getElementById("idArticulo").selectedOptions[0]?.getAttribute("data-precio"));

            if (isNaN(idArticulo) || isNaN(cantidad) || cantidad <= 0 || isNaN(precio)) {
                mostrarMensaje("‚ö†Ô∏è Debe seleccionar un producto y una cantidad v√°lida.", "danger");
                return;
            }

            dto.idArticulo = idArticulo;
            dto.cantidad = cantidad;
            dto.monto = cantidad * precio;
        }

        try {
            const response = await fetch("/api/caja/registrar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRF-TOKEN": csrfToken
                },
                body: JSON.stringify(dto)
            });

            const resultado = await response.text();
            mostrarMensaje(resultado, "success");

            document.getElementById("formCaja").reset();
            document.getElementById("montoVisual").value = "";
            toggleCampos();
        } catch (error) {
            mostrarMensaje("‚ùå Error al registrar movimiento: " + error.message, "danger");
        }
    }

    window.onload = toggleCampos;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
