<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Reporte de Movimientos de Caja</title>
        <link rel="stylesheet" href="/css/bootstrap.min.css">
        <link rel="stylesheet" href="/css/styles.css">
    </head>
    <body>
        <!-- üìå Mensaje flotante -->
        <div id="mensajeFlotante" class="alert" style="position: fixed; top: 20px; right: 20px; display: none;">
            <span id="mensajeTexto"></span>
        </div>
        <div class="container mt-5">
            <h1>Reporte de Movimientos de Caja</h1>

            <div class="mb-3">
                <label for="inicio">Fecha Inicio:</label>
                <input type="datetime-local" id="inicio" class="form-control">
            </div>

            <div class="mb-3">
                <label for="fin">Fecha Fin:</label>
                <input type="datetime-local" id="fin" class="form-control">
            </div>

            <button id="btnGenerarIngreso" class="btn btn-primary">Generar Reporte de Ingresos</button>
            <button id="btnGenerarEgreso" class="btn btn-secondary">Generar Reporte de Egresos</button>
            <a href="/dashboard" class="btn btn-secondary">Volver al Men√∫</a>

            <h2 class="mt-4">Resultados:</h2>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Fecha y Hora</th>
                        <th>Categor√≠a</th>
                        <th>Tipo</th>
                        <th>Descripci√≥n</th>
                        <th>Monto</th>
                    </tr>
                </thead>
                <tbody id="tablaResultados">
                    <!-- Aqu√≠ se insertar√°n los datos -->
                </tbody>
            </table>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // Generar reporte de ingresos
                document.getElementById("btnGenerarIngreso").addEventListener("click", async () => {
                    const inicio = document.getElementById("inicio").value;
                    const fin = document.getElementById("fin").value;

                    let url = `/api/caja/reportes/movimientos?inicio=${encodeURIComponent(inicio)}&fin=${encodeURIComponent(fin)}&tipo=INGRESO`;
                    generarReporte(url, 'INGRESO');
                });

                // Generar reporte de egresos
                document.getElementById("btnGenerarEgreso").addEventListener("click", async () => {
                    const inicio = document.getElementById("inicio").value;
                    const fin = document.getElementById("fin").value;

                    let url = `/api/caja/reportes/movimientos?inicio=${encodeURIComponent(inicio)}&fin=${encodeURIComponent(fin)}&tipo=EGRESO`;
                    generarReporte(url, 'EGRESO');
                });

                async function generarReporte(url, tipo) {
                    const tabla = document.getElementById("tablaResultados");
                    if (!tabla) {
                        console.error("‚ùå ERROR: Elemento tablaResultados no encontrado en el DOM.");
                        alert("Error: No se encontr√≥ la tabla de resultados.");
                        return;
                    }

                    try {
                        const response = await fetch(url, {headers: {'Accept': 'application/json'}});
                        const mensajeFlotante = document.getElementById("mensajeFlotante");
                        const mensajeTexto = document.getElementById("mensajeTexto");
                        if (!response.ok) {
                            throw new Error(`Error HTTP: ${response.status}`);
                            mensajeTexto.textContent = "Error al obtener el reporte";
                            mensajeFlotante.className = "alert alert-danger";
                        }
                        const data = await response.json();
                        console.log("‚úÖ JSON recibido:", data);
                        if (response.ok) {
                            mensajeTexto.textContent = "Reporte generado con √©xito.";
                            mensajeFlotante.className = "alert alert-success";
                        }
                        mensajeFlotante.style.display = "block";
                        setTimeout(() => mensajeFlotante.style.display = "none", 3000);
                        // Limpiar la tabla antes de agregar nuevos datos
                        tabla.innerHTML = "";

                        // Si no hay datos, mostrar un mensaje en la tabla
                        if (data.length === 0) {
                            tabla.innerHTML = "<tr><td colspan='5' class='text-center'>No hay datos disponibles</td></tr>";
                            return;
                        }

                        // Llenar la tabla con los datos recibidos
                        tabla.innerHTML = data.map(mov => {
                            if (tipo === 'EGRESO') {
                                // Si es un reporte de egreso, solo mostrar los campos de Fecha y Hora, Categor√≠a, Tipo, Descripci√≥n y Monto
                                return `
                                    <tr>
                                        <td>${formatearFecha(mov.fechaHora)}</td>
                                        <td>${mov.inventario?.categoria || 'Sin categor√≠a'}</td>
                                        <td>EGRESO</td>
                                        <td>${mov.descripcion}</td>
                                        <td>${formatearMontoPYG(mov.monto)}</td>
                                    </tr>
                                `;
                            } else {
                                // Si es un reporte de ingreso, mostrar todos los campos
                                return `
                                    <tr>
                                        <td>${formatearFecha(mov.fechaHora)}</td>
                                        <td>${mov.inventario ? mov.inventario.nombre : 'N/A'}</td>
                                        <td>${mov.inventario?.categoria || 'Sin categor√≠a'}</td>
                                        <td>INGRESO</td>
                                        <td>${mov.descripcion}</td>
                                        <td>${mov.cantidad ? mov.cantidad : '-'}</td>
                                        <td>${formatearMontoPYG(mov.monto)}</td>
                                        <td>${mov.usuario ? mov.usuario.nombre : 'No asignado'}</td>
                                    </tr>
                                `;
                            }
                        }).join("");

                    } catch (error) {
                        console.error("‚ùå ERROR al generar el reporte:", error);
                        alert("Error al generar el reporte. Revisa la consola para m√°s detalles.");
                    }
                }

                // ‚úÖ Funci√≥n para formatear la fecha en "dd/MM/yyyy HH:mm:ss"
                function formatearFecha(fechaISO) {
                    if (!fechaISO)
                        return "N/A";
                    const fecha = new Date(fechaISO);
                    return `${fecha.getDate().toString().padStart(2, '0')}/${(fecha.getMonth() + 1).toString().padStart(2, '0')}/${fecha.getFullYear()} 
                        ${fecha.getHours().toString().padStart(2, '0')}:${fecha.getMinutes().toString().padStart(2, '0')}:${fecha.getSeconds().toString().padStart(2, '0')}`;
                }

                // ‚úÖ Funci√≥n para formatear la moneda en "100.000 Gs"
                function formatearMontoPYG(monto) {
                    return new Intl.NumberFormat("es-PY").format(monto) + " Gs";
                }
            });
        </script>
    </body>
</html>

